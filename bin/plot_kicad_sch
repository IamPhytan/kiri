#! /bin/bash

# This tool works with Kicad 6
# Tested on 6.0.4-6f826c9f35~116~ubuntu22.04.1
# Requires: xdootool, xvfb

readonly TIME=0.1
readonly PLOT_TIME=1

forced_exit()
{
	kill -9 "${XVFB_PID}" &> /dev/null
	kill -9 "${EESCHEMA_PID}" &> /dev/null
	exit 1
}

get_current_display_server()
{
	# Check the display server in use (x11 or wayland)
	# loginctl show-session $(awk '/tty/ {print $1}' <(loginctl)) -p Type | awk -F= '{print $2}'
	echo "${XDG_SESSION_TYPE}"

	# if [[ -z "${XDG_SESSION_TYPE}" ]]; then
		# env | grep -i wayland
	# fi
}

launch_virtual_display()
{
	export n=":0"
	if [[ -z "$DISPLAY" ]]; then
		export DISPLAY=":${n}.0"
	fi

	# killall Xvfb &>/dev/null
	# rm -rf "/tmp/.X${n}-lock"
	# rm -rf "/tmp/.X${n}-unix/X1"
	# rm -rf "/tmp/.X${n}*"
	# rm -rf "/tmp/xvfb-run.*"

	# xdpyinfo -display ${DISPLAY} > /dev/null

	# Xvfb -f ${DISPLAY} -screen 1 1280x800x24 &
	# Xvfb -f ${DISPLAY} -fbdir /var/tmp 1280x800x24 -dpi 96 &
	# Xvfb -f ${DISPLAY} -screen 0 640x480x8 -nolisten tcp &
	# Xvfb -f ${DISPLAY} -screen 0 1024x768x16 -dpi 96 &
	# Xvfb -f ${DISPLAY} -screen 0 1280x800x24 -ac -dpi 96 +extension RANDR :1 &
	# export XVFB_PID=${!}

	# echo "xvfb-run"
}

get_filename()
{
	local filename="$(basename "${1}")"
	echo "${filename%.*}"
}

get_window_tile()
{
	local win_id="${1}"
	xwininfo -tree -id "${win_id}" 2> /dev/null | grep "xwininfo:" | cut -d" " -f5- | sed "s/\"//g"
}

launch_eeschema()
{
	local kicad_sch_path="${1}"
	local kicad_sch_filename=$(get_filename "${kicad_sch_path}")

	export EESCHEMA_PID
	export EESCHEMA_WIDS

	$(launch_virtual_display) eeschema "${kicad_sch_path}" 2> /dev/null &
	EESCHEMA_PID=${!}

	# list windows
	# xwininfo -tree -root

	setxkbmap us

	# Can be changed externally
	if [[ -z ${WAIT_FOR_EESCHEMA_S} ]]; then
		WAIT_FOR_EESCHEMA_S=0.5
	fi

	# Wait for eeschema to launch the project
	while [[ "$(is_design_loaded "${kicad_sch_filename}")" -ne "1" ]]; do
		sleep ${WAIT_FOR_EESCHEMA_S}
		EESCHEMA_WIDS=($(xdotool search --onlyvisible --sync --classname "Eeschema" 2> /dev/null))
		debug_eeschema_popups
		dismiss_eeschema_popups
	done

	export EESCHEMA_WID=${EESCHEMA_WIDS[0]}
}

debug_eeschema_popups()
{
	IFS=$'\n'
	for win_id in "${EESCHEMA_WIDS[@]}"; do
		# xwininfo -tree -id ${id}
		win_title=$(xwininfo -tree -id "${win_id}" 2> /dev/null | grep "xwininfo:" | cut -d" " -f5- | sed "s/\"//g")
		echo "- [${win_id}] Win title: \"${win_title}\""
	done
}

is_design_loaded()
{
	local project_name="${1}"

	IFS=$'\n'
	for win_id in ${EESCHEMA_WIDS}; do

		# xwininfo -tree -id "${win_id}"
		win_title=$(get_window_tile "${win_id}")

		case ${win_title} in
			*${project_name}*)
				echo "1"
				;;
			*)
				echo "0"
				;;
		esac
	done
}

dissmiss_popup()
{
	local win_id=$1
	echo "- Dismissing popup [${win_id}]"

	xdotool key --window "${win_id}" "Escape" &> /dev/null
	sleep "${TIME}"
}

dismiss_eeschema_popups()
{
	IFS=$'\n'
	for win_id in "${EESCHEMA_WIDS[@]}"; do

		win_title=$(xwininfo -tree -id "${win_id}" 2>/dev/null | grep "xwininfo:" | cut -d" " -f5- | sed "s/\"//g")

		case "${win_title}" in

			"[no schematic loaded] — Schematic Editor")
				;;

			"Loading Schematic")
				;;

			"${project_name} [${project_name}/] — Schematic Editor")
				;;

			"Project Rescue Helper"|"Error*"|"Warning*")
				dissmiss_popup "${win_id}" "${win_title}"
				;;

			*)
				echo "Unknwon popup window [${win_id}] \"${win_title}\""
				;;
		esac
	done
}

launch_plot_window()
{
	# Open Menu File > Plot

	local win_id="${1}"

	xdotool key --window "${win_id}" "alt+f"
	sleep "${TIME}"
	xdotool key --window "${win_id}" "Up"
	sleep "${TIME}"
	xdotool key --window "${win_id}" "Up"
	sleep "${TIME}"
	xdotool key --window "${win_id}" "Return"
	sleep "${TIME}"
}

configure_and_plot()
{
	local win_id="${1}"
	local output_dir_path="${2}"

	# Remove ./ from the path
	# Otherwise Kicad may complain about the path being relative
	output_dir_path=$(echo ${output_dir_path} | sed "s|\./||g" )

	# Write output directory
	xdotool type --window "${win_id}" --delay 1 "${output_dir_path}"
	sleep "${TIME}"

	# Change ouput format to svg
	# It is default on mine, where this is stored?
	# It looks like there is no way to go to a fixed place to this list
	# Or to select a fixed settings
	# xdotool key --window "${win_id}" "Tab"
	# sleep "${TIME}"
	# xdotool key --window "${win_id}" "Tab"
	# sleep "${TIME}"
	# xdotool key --window "${win_id}" "Up"
	# sleep "${TIME}"
	# xdotool key --window "${win_id}" "Up"
	# sleep "${TIME}"
	# xdotool key --window "${win_id}" "space"
	# sleep "${TIME}"


	# Set color mode as black and white
	xdotool key --repeat 4 --delay "${TIME}" "Tab"
	sleep "${TIME}"
	xdotool key --window "${win_id}" "Page_Down"
	sleep "${TIME}"
	xdotool key --repeat 2 --delay "${TIME}" "Return"
	sleep "${TIME}"

	# Plot all pages
	xdotool key --repeat 11 --delay "${TIME}" "Tab"
	sleep "${TIME}"
	xdotool key --window "${win_id}" "Return"
	sleep ${PLOT_TIME}

	# Once more
	xdotool key --window "${win_id}" "Return"
	sleep ${PLOT_TIME}

	# Once more
	xdotool key --window "${win_id}" "Return"
	sleep ${PLOT_TIME}


	# Once more
	xdotool key --window "${win_id}" "Escape"
	sleep ${PLOT_TIME}
}

main()
{
	trap "exit 1" TERM
	trap forced_exit INT

	if [[ "$(get_current_display_server)" != "x11" ]] && [[ "$(get_current_display_server)" != "wayland" ]]; then
		echo "Error: Unknown display server \"$(get_current_display_server)\""
		echo "Only x11, xwayland are currently supported"
		#exit 1
	fi

	local kicad_sch_path="${1}"
	local output_dir_path="${2}"

	file_name=$(basename -- "${kicad_sch_path}")
	project_name="${file_name%.*}"

	if [[ ! -f "${kicad_sch_path}" ]]; then
		echo "Missing .kicad_sch file"
		exit 1
	fi

	if [[ "${#}" -lt 2 ]]; then
		output_dir_path="."
	else
		output_dir_path="${2}"
		if [[ ! -d "${output_dir_path}" ]]; then
			echo "Error: \"${output_dir_path}\" does not exist"
			exit 1
		fi
	fi

	echo -e "\nDisplay server = $(get_current_display_server)"
	echo -e "Schematic_path = ${kicad_sch_path}"
	echo -e "   Output_path = ${output_dir_path}\n"

	local temp_dir=$(mktemp -d -p "${output_dir_path}")
	local output_temp_dir_path="${output_dir_path}/${temp_dir}"
	mkdir -p "${output_temp_dir_path}" &> /dev/null

	launch_eeschema "${kicad_sch_path}" #&> /dev/null
	# echo -e "\n   eeschema_pid = ${EESCHEMA_PID}"
	# echo -e "main_window_ids = ${EESCHEMA_WIDS[@]}"
	# echo -e " main_window_id = ${EESCHEMA_WID}"

	launch_plot_window "${EESCHEMA_WID}" 2> /dev/null
	configure_and_plot "${EESCHEMA_WID}" "${output_temp_dir_path}" 2> /dev/null

	kill -9 "${EESCHEMA_PID}" &> /dev/null

	# Organize generated files for KiRI
	svg_file_paths=($(find "${output_temp_dir_path}" -name "*.svg"))

	if [[ -n ${svg_file_paths} ]]; then
		IFS=$'\n'
		for svg_file in "${svg_file_paths[@]}"; do
			new_file=$(echo "${svg_file}" | sed "s|${temp_dir}/|sch-|g" )
			echo "      Ploting = ${new_file}"
			mv "${svg_file}" "${new_file}" 2> /dev/null
		done
		echo
	fi

	# remove temporary folder
	rm -rf "${output_temp_dir_path}"
}

main "${@}" | tee .kiri.log
